<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:DnDClient.Converters"
             xmlns:vm="clr-namespace:DnDClient.ViewModels"
             x:Class="DnDClient.Views.CombatPage">
    <ContentPage.Resources>
        <conv:NpcFilterConverter x:Key="NpcFilterConverter" />
        <conv:EnemyFilterConverter x:Key="EnemyFilterConverter" />
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Информация о текущем ходе -->
            <StackLayout Grid.Row="0" Grid.ColumnSpan="2" Padding="10">
                <Button Text="Управлять участниками" Command="{Binding ManageParticipantsCommand}" CommandParameter=""></Button>
                <Label Text="Раунд:" FontAttributes="Bold" />
                <Label Text="{Binding Combat.CurrentRound}" />
                <Label Text="Текущий ходящий:" FontAttributes="Bold" />
                <Label Text="{Binding Combat.CurrentParticipant.Name}" />
            </StackLayout>

            <!-- Основная область: логи и участники -->
            <Grid Grid.Row="1" Grid.ColumnSpan="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Логи боя -->
                <Grid Grid.Column="0" Padding="10" RowDefinitions="Auto,*">
                    <Label Text="Логи боя" FontAttributes="Bold" Grid.Row="0"/>
                    <CollectionView ItemsSource="{Binding CombatLogs}" Grid.Row="1">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Margin="2" Padding="5" BorderColor="Gray">
                                    <Label Text="{Binding Message}" />
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
                <Grid Grid.Row="1" Grid.Column="0" Padding="10" IsVisible="{Binding MasterMode}" RowDefinitions="Auto,*">
                    <Label Text="Ожидающие ходы" FontAttributes="Bold" Grid.Row="0"/>
                    <CollectionView ItemsSource="{Binding PendingLogs}" Grid.Row="1">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Margin="2" Padding="5" BorderColor="Gray">
                                    <StackLayout>
                                        <Label Text="{Binding Message}" />
                                        <Button Text="Подтвердить"
                                                Command="{Binding BindingContext.ConfirmActionCommand, Source={x:Reference Name=CombatPage}}"
                                                CommandParameter="{Binding .}" />
                                    </StackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>

                <Grid Grid.Column="1" Grid.RowSpan="2" Padding="10" RowDefinitions="Auto,*">
                    <Label Text="Участники" Grid.Row="0" FontAttributes="Bold" />
                    <CollectionView Grid.Row="1" ItemsSource="{Binding Combat.Participants}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Margin="2" Padding="5" BorderColor="Gray">
                                    <StackLayout>
                                        <Label Text="{Binding Name}" />
                                        <Label Text="{Binding CurrentHitPoints}" FontSize="10" />
                                        <Label Text="{Binding Type}" FontSize="10" />
                                    </StackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Grid>

            <!-- UI для игрока -->
            <StackLayout Grid.Row="2" Grid.ColumnSpan="2" Padding="10" IsVisible="{Binding IsPlayerTurn}">
                <Label Text="Ваш ход" FontAttributes="Bold" />
                <Picker Title="Цель" ItemsSource="{Binding Combat.Participants}" ItemDisplayBinding="{Binding Name}"/>
                <Entry Placeholder="Урон/лечение" Keyboard="Numeric" Text="{Binding AttackDamage}" />
                <Button Text="Отправить ход" Command="{Binding SendPlayerActionCommand}" />
            </StackLayout>

            <!-- UI для мастера -->
            <StackLayout Grid.Row="2" Grid.Column="0" Padding="10" IsVisible="{Binding MasterMode}">
                <Label Text="Управление НПС" FontAttributes="Bold" />
                <Picker Title="Выберите НПС"
                        ItemsSource="{Binding Combat.Participants, Converter={StaticResource NpcFilterConverter}}"
                        ItemDisplayBinding="{Binding Name}"
                        SelectedItem="{Binding SelectedNpc}" />
                <Picker Title="Цель" ItemsSource="{Binding Combat.Participants}" ItemDisplayBinding="{Binding Name}"
                        SelectedItem="{Binding SelectedTarget}" />
                <Entry Placeholder="Урон/лечение" Keyboard="Numeric" Text="{Binding AttackDamage}" />
                <Button Text="Отправить ход за НПС" Command="{Binding SendNpcActionCommand}" BackgroundColor="#4CAF50"
                        TextColor="White" />
            </StackLayout>

            <StackLayout Grid.Row="2" Grid.Column="1" Padding="10" IsVisible="{Binding MasterMode}">
                <Label Text="Управление врагами" FontAttributes="Bold" />
                <Picker Title="Выберите врага"
                        ItemsSource="{Binding Combat.Participants, Converter={StaticResource EnemyFilterConverter}}"
                        ItemDisplayBinding="{Binding Name}"
                        SelectedItem="{Binding SelectedEnemy}" />
                <Picker Title="Цель" ItemsSource="{Binding Combat.Participants}" ItemDisplayBinding="{Binding Name}"
                        SelectedItem="{Binding SelectedTarget}" />
                <Entry Placeholder="Урон/лечение" Keyboard="Numeric" Text="{Binding AttackDamage}" />
                <Button Text="Отправить ход за врага" Command="{Binding SendEnemyActionCommand}"
                        BackgroundColor="#FF5722" TextColor="White" />
            </StackLayout>
        </Grid>
    </ContentPage.Content>
</ContentPage>