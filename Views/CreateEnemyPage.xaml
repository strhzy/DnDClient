<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="using:DnDClient.Views"
             x:Class="DnDClient.Views.CreateEnemyPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             Title="{Binding Title}">
    <ContentPage.Resources>
        <Style x:Key="InvalidEntryStyle" TargetType="Entry">
            <Setter Property="TextColor" Value="Red" />
            <!-- Можно добавить другие свойства, например, BackgroundColor -->
        </Style>
        <Style x:Key="ValidEntryStyle" TargetType="Entry">
            <Setter Property="TextColor" Value="Green" />
        </Style>
    </ContentPage.Resources>
    <ContentPage.Content>
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="16">
                <Entry Placeholder="Имя" Text="{Binding Name}" />
                <Entry Placeholder="Тип" Text="{Binding Type}" />
                <Entry Placeholder="Здоровье" Keyboard="Numeric" Text="{Binding HitPoints}">
                    <Entry.Behaviors>
                        <toolkit:NumericValidationBehavior
                            InvalidStyle="{StaticResource InvalidEntryStyle}"
                            ValidStyle="{StaticResource ValidEntryStyle}"
                            Flags="ValidateOnValueChanged"
                            MinimumValue="1.0"
                            MaximumValue="100.0"
                            MaximumDecimalPlaces="2" />
                    </Entry.Behaviors>
                </Entry>
                <Entry Placeholder="Класс брони" Keyboard="Numeric" Text="{Binding ArmorClass}">
                    <Entry.Behaviors>
                        <toolkit:NumericValidationBehavior
                            InvalidStyle="{StaticResource InvalidEntryStyle}"
                            ValidStyle="{StaticResource ValidEntryStyle}"
                            Flags="ValidateOnValueChanged"
                            MinimumValue="1.0"
                            MaximumValue="100.0"
                            MaximumDecimalPlaces="2" />
                    </Entry.Behaviors>
                </Entry>
                <Entry Placeholder="CR" Text="{Binding ChallengeRating}" />
                <Editor Placeholder="Описание" HeightRequest="100" Text="{Binding Description}" />

                <Frame Padding="10" Margin="0,10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Специальные способности" FontAttributes="Bold" />
                        <Button Text="Добавить способность" Command="{Binding AddAbilityCommand}" />
                        <CollectionView ItemsSource="{Binding SpecialAbilities}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,5" Padding="10">
                                        <Grid ColumnDefinitions="*, Auto">
                                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                                <Entry Text="{Binding Name}" Placeholder="Название" />
                                                <Editor Text="{Binding Description}"
                                                        Placeholder="Описание"
                                                        HeightRequest="60"
                                                        AutoSize="TextChanges" />
                                            </VerticalStackLayout>
                                            <Button Grid.Column="1"
                                                    Text="🗑️"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:CreateEnemyPage}}, Path=BindingContext.DelAbilityCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#F44336"
                                                    TextColor="White"
                                                    WidthRequest="40" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <Frame Padding="10" Margin="0,10">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Атаки" FontAttributes="Bold" />
                        <Button Text="Добавить атаку" Command="{Binding AddAttackCommand}" />
                        <CollectionView ItemsSource="{Binding Attacks}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,5" Padding="10">
                                        <Grid ColumnDefinitions="*, *, Auto">
                                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                                <Entry Text="{Binding Name}" Placeholder="Название" />
                                                <Entry Text="{Binding AttackBonus}" Placeholder="Бонус атаки" />
                                            </VerticalStackLayout>
                                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                                <Entry Text="{Binding DamageDice}" Placeholder="Кость урона" />
                                                <Entry Text="{Binding DamageBonus}" Placeholder="Бонус урона" />
                                            </VerticalStackLayout>
                                            <Button Grid.Column="2"
                                                    Text="🗑️"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:CreateEnemyPage}}, Path=BindingContext.DelAttackCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#F44336"
                                                    TextColor="White"
                                                    WidthRequest="40" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <Button Text="{Binding ActionButtonText}"
                        Command="{Binding SaveCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        Margin="0,20,0,0" />
            </VerticalStackLayout>
        </ScrollView>
    </ContentPage.Content>
</ContentPage>